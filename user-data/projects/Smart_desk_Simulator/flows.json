[
    {
        "id": "00faea911c2e17d1",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d7a9ea05a589f28e",
        "type": "mqtt-broker",
        "name": "",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "5ed1155aaed18428",
        "type": "influxdb",
        "hostname": "127.0.0.1",
        "port": 8086,
        "protocol": "http",
        "database": "database",
        "name": "Local Influx 2",
        "usetls": false,
        "tls": "",
        "influxdbVersion": "2.0",
        "url": "http://localhost:8086",
        "timeout": 10,
        "rejectUnauthorized": true
    },
    {
        "id": "44cfd562e37fa1a8",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-influxdb": "0.7.0"
        }
    },
    {
        "id": "34345f3168db1b64",
        "type": "mqtt out",
        "z": "00faea911c2e17d1",
        "name": "Smart_Desk_Publisher",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "d7a9ea05a589f28e",
        "x": 780,
        "y": 60,
        "wires": []
    },
    {
        "id": "661921696d231a7c",
        "type": "inject",
        "z": "00faea911c2e17d1",
        "name": "Tick-Smart Desk",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "20",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 210,
        "y": 260,
        "wires": [
            [
                "92d994a8c47c6d3e"
            ]
        ]
    },
    {
        "id": "92d994a8c47c6d3e",
        "type": "function",
        "z": "00faea911c2e17d1",
        "name": "Smart Desk Sensor Simulation",
        "func": "// ===== Smart Desk Enhanced Simulator â€“ DEMO MODE (time-warped) =====\nfunction rand(min, max) { return Math.round(Math.random() * (max - min) + min); }\nfunction rfloat(min, max, d = 1) { return parseFloat((Math.random() * (max - min) + min).toFixed(d)); }\n\nconst REAL_TICK_SEC = 30;\nconst DEMO_MIN_PER_TICK = 3;\nconst TICK_SIM_SEC = DEMO_MIN_PER_TICK * 60;\n\nlet state = flow.get(\"focusState\") || {\n    mode: \"focus\",\n    remainingSec: 25 * 60,\n    sitStreakSec: 0,\n    standCyclesToday: 0\n};\n\n// --- 1. Presence & mode handling ---\nlet present = Math.random() < (state.mode === \"focus\" ? 0.8 : 0.3);\n\n// Advance Pomodoro-style timer\nstate.remainingSec -= TICK_SIM_SEC;\nif (state.remainingSec <= 0) {\n    if (state.mode === \"focus\") {\n        state.mode = \"break\";\n        state.remainingSec = 5 * 60;\n    } else {\n        state.mode = \"focus\";\n        state.remainingSec = 25 * 60;\n    }\n}\n\n// --- 2. Sitting / standing behaviour ---\nlet sitStandState;\nif (present) {\n    sitStandState = Math.random() < 0.95 ? 0 : 1;\n} else {\n    sitStandState = 1;\n}\n\n// Sitting streak logic\nif (present && sitStandState === 0) {\n    state.sitStreakSec += TICK_SIM_SEC;\n} else if (state.sitStreakSec > 0) {\n    state.sitStreakSec = 0;\n    state.standCyclesToday += 1;\n}\n\n// --- 3. Core sensor readings ---\nconst deskHeightCm = sitStandState ? rand(100, 120) : rand(70, 90);\nconst temperatureC = rfloat(22, 26, 1);\nconst lightLux = rand(150, 600);\nconst humidityPct = rand(35, 60);\nconst noiseDb = rand(42, 74);\nconst co2ppm = rand(500, 1400);\nconst lampOn = present && lightLux < 300;\nconst lampPowerW = lampOn ? (lightLux < 220 ? 9 : 6) : 0;\nconst focusScore = present ? (state.mode === \"focus\" ? rand(60, 95) : rand(30, 70)) : 0;\nconst keyRatePerMin = present ? (state.mode === \"focus\" ? rand(80, 220) : rand(10, 120)) : 0;\nconst screenOn = present ? 1 : 0;\nconst postureAngleDeg = present ? rand(5, 35) : 0;\nconst postureGood = present ? (postureAngleDeg < 25) : 1;\nconst microbreakDue = (state.mode === \"focus\" && (state.remainingSec % (10 * 60) < TICK_SIM_SEC)) ? 1 : 0;\n\n// --- 4. Build payload ---\nconst payload = {\n    deskId: \"desk01\",\n    userId: \"user01\",\n    appFocus: [\"IDE\", \"Browser\", \"Mail\", \"Other\"][rand(0, 3)],\n    present: present,\n    sitStandState: sitStandState,\n    sitStreakMin: Math.round(state.sitStreakSec / 60),\n    standCyclesToday: state.standCyclesToday,\n    deskHeightCm,\n    temperatureC,\n    lightLux,\n    humidityPct,\n    noiseDb,\n    co2ppm,\n    lampOn,\n    lampPowerW,\n    screenOn,\n    focusScore,\n    keyRatePerMin,\n    postureAngleDeg,\n    postureGood,\n    microbreakDue,\n    focusTimerMin: Math.max(0, Math.round(state.remainingSec / 60)),\n    mode: state.mode,\n    ts: new Date().toISOString()\n};\n\nflow.set(\"focusState\", state);\n\nmsg.topic = \"desk/desk01/telemetry\";\nmsg.payload = JSON.stringify(payload);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 140,
        "wires": [
            [
                "34345f3168db1b64"
            ]
        ]
    },
    {
        "id": "afd6ced74296e452",
        "type": "mqtt in",
        "z": "00faea911c2e17d1",
        "name": "Smart Desk Telemetry IN",
        "topic": "desk/desk01/telemetry",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "d7a9ea05a589f28e",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 210,
        "y": 360,
        "wires": [
            [
                "a17d74df0fecba88"
            ]
        ]
    },
    {
        "id": "a17d74df0fecba88",
        "type": "json",
        "z": "00faea911c2e17d1",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 410,
        "y": 360,
        "wires": [
            [
                "8c58fa0660fa325d",
                "afdbd8acdcf68747",
                "2298db7fbec8d873"
            ]
        ]
    },
    {
        "id": "5a872dc6776bb546",
        "type": "influxdb out",
        "z": "00faea911c2e17d1",
        "influxdb": "5ed1155aaed18428",
        "name": "Seating Sensor Details",
        "measurement": "desk_seating",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "iot-org",
        "bucket": "smartDeskDatabase",
        "x": 1020,
        "y": 220,
        "wires": []
    },
    {
        "id": "8c58fa0660fa325d",
        "type": "function",
        "z": "00faea911c2e17d1",
        "name": "Capture Seating Sensor details",
        "func": "let p = msg.payload;\nif (typeof p === \"string\") {\n    try { p = JSON.parse(p); }\n    catch (e) { node.warn(\"Bad JSON in seating details: \" + e.message); return null; }\n}\nif (!p || !p.deskId || !p.userId) return null;\n\nconst presentVal = p.present ? 1 : 0;\n\nmsg.measurement = \"desk_seating\";\nmsg.tags = {\n    deskId: p.deskId,\n    userId: p.userId,\n    mode: p.mode || \"unknown\"\n};\n\n// *** Now build the InfluxDB payload ***\nmsg.payload = {\n    present: presentVal,\n    sitStandState: Number(p.sitStandState) || 0,   // 0=sit, 1=stand\n    sitStreakMin: Number(p.sitStreakMin) || 0,\n    standCyclesToday: Number(p.standCyclesToday) || 0,\n    deskHeightCm: Number(p.deskHeightCm) || 0,\n    postureAngleDeg: Number(p.postureAngleDeg) || 0,\n    postureGood: p.postureGood ? 1 : 0,\n};\n\nmsg.timestamp = p.ts ? new Date(p.ts) : new Date();\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "\n",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 260,
        "wires": [
            [
                "5a872dc6776bb546",
                "b1e7acccda9a6270"
            ]
        ]
    },
    {
        "id": "afdbd8acdcf68747",
        "type": "function",
        "z": "00faea911c2e17d1",
        "name": "Capture Environment Sensor Details",
        "func": "let p = msg.payload;\nif (typeof p === \"string\") {\n    try { p = JSON.parse(p); }\n    catch (e) { node.warn(\"Bad JSON in environment details: \" + e.message); return null; }\n}\nif (!p || !p.deskId || !p.userId) return null;\n\n// Basic values\nconst presentVal = p.present ? 1 : 0;\nconst lampVal = p.lampOn ? 1 : 0;\nconst mode = p.mode || \"focus\";\nconst TICK_SEC = 30;\n\n// Rolling timers from flow context\nlet highCo2Sec = flow.get(\"highCo2Sec\") || 0;\nlet lowLightSec = flow.get(\"lowLightSec\") || 0;\nlet postureBadSec = flow.get(\"postureBadSec\") || 0;\n\n// Thresholds (seconds)\nconst HIGH_CO2_THRESHOLD_SEC = 15 * 60;\nconst LOW_LIGHT_THRESHOLD_SEC = 5 * 60;\nconst BAD_POSTURE_THRESHOLD_SEC = 20 * 60;\n\n// Accumulate CO2 exposure\nif (Number(p.co2ppm) > 1000) {\n    highCo2Sec += TICK_SEC;\n} else {\n    highCo2Sec = 0;\n}\n\n// Accumulate low light while present and lamp off\nconst LOW_LIGHT_CRITERIA = presentVal && !lampVal && (Number(p.lightLux) < 250);\nif (LOW_LIGHT_CRITERIA) {\n    lowLightSec += TICK_SEC;\n} else {\n    lowLightSec = 0;\n}\n\n// Accumulate bad posture while present and postureGood=0\nconst POSTURE_CRITERIA = presentVal && !p.postureGood;\nif (POSTURE_CRITERIA) {\n    postureBadSec += TICK_SEC;\n} else {\n    postureBadSec = 0;\n}\n\n// Derive warnings\nconst dimLightWarning = (lowLightSec >= LOW_LIGHT_THRESHOLD_SEC) ? 1 : 0;\nconst highCo2Warning = (highCo2Sec >= HIGH_CO2_THRESHOLD_SEC) ? 1 : 0;\nconst badPostureWarning = (postureBadSec >= BAD_POSTURE_THRESHOLD_SEC) ? 1 : 0;\n\n// Build friendly messages for dashboard\nlet messages = [];\nif (dimLightWarning) messages.push(\"Lighting is low â€” turn on lamp or open blinds.\");\nif (highCo2Warning) messages.push(\"COâ‚‚ is high â€” open a window or take a fresh air break.\");\nif (badPostureWarning) messages.push(\"Posture is poor â€” adjust chair/desk or stand up.\");\n\nif (!messages.length) {\n    if (presentVal) {\n        messages.push(`All good â€” environment and posture look fine in ${mode} mode.`);  // *** FIXED: backticks, not parenthesis ***\n    } else {\n        messages.push(\"Desk is idle â€” no user present.\");\n    }\n}\n\n// Save state back to flow\nflow.set(\"highCo2Sec\", highCo2Sec);\nflow.set(\"lowLightSec\", lowLightSec);\nflow.set(\"postureBadSec\", postureBadSec);\n\n// Map to Influx measurement\nmsg.measurement = \"desk_environment\";\nmsg.tags = {\n    deskId: p.deskId,\n    userId: p.userId,\n    mode: mode\n};\n\nmsg.payload = {\n    // Raw environment values\n    temperatureC: Number(p.temperatureC) || 0,\n    humidityPct: Number(p.humidityPct) || 0,\n    co2ppm: Number(p.co2ppm) || 0,\n    noiseDb: Number(p.noiseDb) || 0,\n    lightLux: Number(p.lightLux) || 0,\n    lampOn: lampVal,\n    lampPowerW: Number(p.lampPowerW) || 0,\n\n    // Rolling exposure timers\n    highCo2Sec,\n    lowLightSec,\n    postureBadSec,\n\n    // Warnings + narrative\n    dimLightWarning,\n    highCo2Warning,\n    badPostureWarning,\n    environmentNotifyText: messages.join(\" | \")\n};\n\nmsg.timestamp = p.ts ? new Date(p.ts) : new Date();\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 380,
        "wires": [
            [
                "9b8a56e37aaff542",
                "de0606e435137763"
            ]
        ]
    },
    {
        "id": "2298db7fbec8d873",
        "type": "function",
        "z": "00faea911c2e17d1",
        "name": "Build Desk Status Sensor",
        "func": "let p = msg.payload;\nif (typeof p === \"string\") {\n    try { p = JSON.parse(p); }\n    catch (e) { node.warn(\"Bad JSON in status details: \" + e.message); return null; }\n}\nif (!p || !p.deskId || !p.userId) return null;\n\nconst TICK_SEC = 30;\nconst presentVal = p.present ? 1 : 0;\nconst mode = p.mode || \"focus\";\n\n// ---- Rolling focus timer (low focus) ----\nlet lowFocusSec = flow.get(\"lowFocusSec\") || 0;\nif (presentVal && Number(p.focusScore) < 50) {\n    lowFocusSec += TICK_SEC;\n} else {\n    lowFocusSec = 0;\n}\n\n// Thresholds\nconst LONG_SIT_THRESHOLD_MIN = 45;\nconst LOW_FOCUS_THRESHOLD_SEC = 10 * 60;\nconst HIGH_CO2_THRESHOLD_SEC = 15 * 60;\nconst LOW_LIGHT_THRESHOLD_SEC = 5 * 60;\n\n// Warnings (ergonomics & focus)\nconst longSitWarning = (Number(p.sitStreakMin) >= LONG_SIT_THRESHOLD_MIN) ? 1 : 0;\nconst lowFocusWarning = (lowFocusSec >= LOW_FOCUS_THRESHOLD_SEC) ? 1 : 0;\nconst postureWarning = (presentVal && !p.postureGood) ? 1 : 0;\n\n// Retrieve env warnings from flow context (set by environment node)\nlet highCo2Sec = flow.get(\"highCo2Sec\") || 0;\nlet lowLightSec = flow.get(\"lowLightSec\") || 0;\nlet postureBadSec = flow.get(\"postureBadSec\") || 0;\n\nconst dimLightWarning = (lowLightSec >= LOW_LIGHT_THRESHOLD_SEC) ? 1 : 0;\nconst highCo2Warning = (highCo2Sec >= HIGH_CO2_THRESHOLD_SEC) ? 1 : 0;\n\n// Save focus timer state\nflow.set(\"lowFocusSec\", lowFocusSec);\n\n// Build one combined assistant message\nlet messages = [];\nif (longSitWarning) messages.push(\"You have been sitting for more than 45 minutes â€” take a movement break.\");\nif (postureWarning) messages.push(\"Your posture is off â€” straighten your back and adjust desk height.\");\nif (lowFocusWarning) messages.push(\"Focus has been low for 10+ minutes â€” try a quick reset or walk.\");\nif (dimLightWarning) messages.push(\"Lighting has been low â€” increase ambient light to reduce eye strain.\");\nif (highCo2Warning) messages.push(\"COâ‚‚ levels have been high â€” get fresh air or increase ventilation.\");\n\nif (!messages.length) {\n    if (presentVal) {\n        messages.push(\"All good â€” posture, environment, and focus look balanced right now.\");\n    } else {\n        messages.push(\"Desk is idle â€” no recommendations at this time.\");\n    }\n}\n\nmsg.measurement = \"desk_status\";\nmsg.tags = {\n    deskId: p.deskId,\n    userId: p.userId,\n    mode: mode\n};\n\nmsg.payload = {\n    present: presentVal,\n    mode,\n    focusScore: Number(p.focusScore) || 0,\n    sitStreakMin: Number(p.sitStreakMin) || 0,\n    postureGood: p.postureGood ? 1 : 0,\n\n    // Derived timers\n    lowFocusSec,\n    highCo2Sec,\n    lowLightSec,\n    postureBadSec,  // Added for completeness\n\n    // Warnings\n    longSitWarning,\n    lowFocusWarning,\n    postureWarning,\n    dimLightWarning,\n    highCo2Warning,\n\n    // Narrative\n    smartDeskAssistant: messages.join(\" \")\n};\n\nif (longSitWarning) {\n    node.warn(`ðŸš¨ LONG SIT ALERT TRIGGERED! sitStreakMin = ${p.sitStreakMin}`);\n}\n\nmsg.timestamp = p.ts ? new Date(p.ts) : new Date();\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 520,
        "wires": [
            [
                "da46810f98515547",
                "ddd6db1389b43535"
            ]
        ]
    },
    {
        "id": "9b8a56e37aaff542",
        "type": "influxdb out",
        "z": "00faea911c2e17d1",
        "influxdb": "5ed1155aaed18428",
        "name": "Environment & Light Sensor Details",
        "measurement": "desk_environment",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "iot-org",
        "bucket": "smartDeskDatabase",
        "x": 1060,
        "y": 360,
        "wires": []
    },
    {
        "id": "da46810f98515547",
        "type": "influxdb out",
        "z": "00faea911c2e17d1",
        "influxdb": "5ed1155aaed18428",
        "name": "Desk Status Sensor Details",
        "measurement": "desk_status",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "iot-org",
        "bucket": "smartDeskDatabase",
        "x": 1000,
        "y": 480,
        "wires": []
    },
    {
        "id": "ddd6db1389b43535",
        "type": "debug",
        "z": "00faea911c2e17d1",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 960,
        "y": 560,
        "wires": []
    },
    {
        "id": "de0606e435137763",
        "type": "debug",
        "z": "00faea911c2e17d1",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 980,
        "y": 420,
        "wires": []
    },
    {
        "id": "b1e7acccda9a6270",
        "type": "debug",
        "z": "00faea911c2e17d1",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 980,
        "y": 300,
        "wires": []
    }
]